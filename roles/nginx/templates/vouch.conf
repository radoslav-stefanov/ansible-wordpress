#  location = /validate {
#    proxy_pass http://vouch_{{ strip_domain.stdout|replace(".", "_")|replace("-", "_") }}:9090/validate;
#    # pass the original host header
#    proxy_set_header Host $http_host;
#
#    # Vouch Proxy only acts on the request headers
#    proxy_pass_request_body off;
#    proxy_set_header Content-Length "";
#
#    auth_request_set $auth_resp_x_vouch_user $upstream_http_x_vouch_user;
#    auth_request_set $auth_resp_jwt $upstream_http_x_vouch_jwt;
#    auth_request_set $auth_resp_err $upstream_http_x_vouch_err;
#    auth_request_set $auth_resp_failcount $upstream_http_x_vouch_failcount;
#  }
#
#  error_page 401 = @error401;
#
#  location @error401 {
#    return 302 https://auth.{{ strip_domain.stdout }}/login?url=https://$http_host$request_uri&vouch-failcount=$auth_resp_failcount&X-Vouch-Token=$auth_resp_jwt&error=$auth_resp_err;
#  }

  location ^~ /my-admin/ {
#    auth_request /validate;
    index index.html
    try_files $uri $uri/ /my-admin/index.html;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "Upgrade";
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forward-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forward-Proto $scheme;
    proxy_redirect off;
  }

  location ^~ /my-admin/pma/ {
#    auth_request /validate;
    proxy_pass http://pma_{{ app_host }}/;
    proxy_redirect off;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

#  # Proxy Grafana Live WebSocket connections.
#  location ^~ /my-admin/grafana/api/live/ {
#    proxy_pass http://{{ app_host }}_grafana:3000;
#    proxy_http_version 1.1;
#    proxy_set_header Upgrade $http_upgrade;
#    proxy_set_header Connection "Upgrade";
#    proxy_set_header Host $http_host;
#    proxy_set_header X-Real-IP $remote_addr;
#    proxy_set_header X-Forward-For $proxy_add_x_forwarded_for;
#    proxy_set_header X-Forward-Proto $scheme;
#  }

#  location ^~ /my-admin/ws {
##    auth_request /validate;
#    proxy_pass http://goaccess_{{ app_host }}:7890/;
#    proxy_http_version 1.1;
#    proxy_set_header Upgrade $http_upgrade;
#    proxy_set_header Connection "Upgrade";
#    proxy_set_header Host $http_host;
#    proxy_set_header X-Real-IP $remote_addr;
#    proxy_set_header X-Forward-For $proxy_add_x_forwarded_for;
#    proxy_set_header X-Forward-Proto $scheme;
#  }

  location ^~ /my-admin/grafana/ {
#    auth_request /validate;
    proxy_pass http://{{ app_host }}_grafana:3000/;
    proxy_redirect off;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  location ^~ /my-admin/webftp/ {
#    auth_request /validate;
    proxy_pass http://filebrowser_{{ app_host }}/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "Upgrade";
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forward-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forward-Proto $scheme;
    proxy_redirect off;
  }

  location ^~ /my-admin/logs/ {
#    auth_request /validate;
    proxy_pass http://logs_{{ app_host }}:8080/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "Upgrade";
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forward-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forward-Proto $scheme;
    proxy_redirect off;
  }

  location ^~ /my-admin/ssh/ {
#    auth_request /validate;
    proxy_pass http://web_terminal_{{ app_host }}:7681/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "Upgrade";
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forward-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forward-Proto $scheme;
    proxy_redirect off;
  }

#  location ^~ /my-admin/ws {
##    auth_request /validate;
#    proxy_pass http://goaccess_{{ app_host }}:7890/;
#    proxy_http_version 1.1;
#    proxy_set_header Upgrade $http_upgrade;
#    proxy_set_header Connection "Upgrade";
#    proxy_set_header Host $http_host;
#    proxy_set_header X-Real-IP $remote_addr;
#    proxy_set_header X-Forward-For $proxy_add_x_forwarded_for;
#    proxy_set_header X-Forward-Proto $scheme;
#  }

  location /my-admin/backups {
    return 301 $scheme://$host/my-admin/backups/;
  }

  location ^~ /my-admin/backups/ {
    resolver 127.0.0.11 valid=30s;
    set $upstream_app duplicati_{{ app_host }};
    set $upstream_port 8200;
    set $upstream_proto http;
    proxy_pass $upstream_proto://$upstream_app:$upstream_port;

    rewrite /my-admin/backups(.*) $1 break;

    proxy_redirect off;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

  }

  location /my-admin/full-backups/ {
      index index.html;
      autoindex on;
      autoindex_exact_size off;
      autoindex_format html;
      autoindex_localtime on;
  }

#{% if stage is not defined %}
#  location /my-admin/stage/ {
#    proxy_pass http://stage_{{ app_host }}_nginx/;
#    proxy_redirect off;
#    proxy_set_header Host $host;
#    proxy_set_header X-Real-IP $remote_addr;
#    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#  }
#{% endif %}
