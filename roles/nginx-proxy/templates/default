add_header Cache-Status $upstream_cache_status;
add_header Cache-BYPASS-Reason $skip_reason;

# define nginx variables
set $skip_cache 0;
set $skip_reason "";

# security for bypass so localhost can empty cache
if ($remote_addr ~ "^(127.0.0.1|Web.Server.IP)$") {
    set $bypass $http_secret_header;
}

# skip caching WordPress cookies
if ($http_cookie ~* "comment_author_|wordpress_(?!test_cookie)|wp-postpass_" ) {
    set $skip_cache 1;
    set $skip_reason Cookie;
}

# Don't cache URIs containing the following segments
if ($request_uri ~* "/wp-admin/|/xmlrpc.php|wp-.*.php|/feed/|sitemap(_index)?.xml") {
    set $skip_cache 1;
    set $skip_reason URI;
}

{% if cluster is defined %}
{% if not inventory_hostname == groups["proxy"][0] %}
# Redirect Let's Encrypt authentication to central server
location ^~ /.well-known/ {
      proxy_pass           http://{{ hostvars[groups['proxy'][0]].ansible_host }};
      proxy_redirect       off;
      proxy_set_header     Host $http_host;
      proxy_set_header     X-Real-IP $remote_addr;
      proxy_set_header     X-Forwarded-For $proxy_add_x_forwarded_for;
}
{% endif %}
{% endif %}
